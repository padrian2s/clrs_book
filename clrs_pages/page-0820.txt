27.3 Multithreaded merge sort                                                           799


index q2 in the subarray T Œp2 : : r2  so that the subarray would still be sorted if we
inserted x between T Œq2  1 and T Œq2 .
   We next merge the original subarrays T Œp1 : : r1  and T Œp2 : : r2  into AŒp3 : : r3 
as follows:
1. Set q3 D p3 C .q1  p1 / C .q2  p2 /.
2. Copy x into AŒq3 .
3. Recursively merge T Œp1 : : q1  1 with T Œp2 : : q2  1, and place the result into
   the subarray AŒp3 : : q3  1.
4. Recursively merge T Œq1 C 1 : : r1  with T Œq2 : : r2 , and place the result into the
   subarray AŒq3 C 1 : : r3 .
When we compute q3 , the quantity q1 p1 is the number of elements in the subarray
T Œp1 : : q1  1, and the quantity q2  p2 is the number of elements in the subarray
T Œp2 : : q2  1. Thus, their sum is the number of elements that end up before x in
the subarray AŒp3 : : r3 .
   The base case occurs when n1 D n2 D 0, in which case we have no work
to do to merge the two empty subarrays. Since we have assumed that the sub-
array T Œp1 : : r1  is at least as long as T Œp2 : : r2 , that is, n1  n2 , we can check
for the base case by just checking whether n1 D 0. We must also ensure that the
recursion properly handles the case when only one of the two subarrays is empty,
which, by our assumption that n1  n2 , must be the subarray T Œp2 : : r2 .
   Now, let’s put these ideas into pseudocode. We start with the binary search,
which we express serially. The procedure B INARY-S EARCH .x; T; p; r/ takes a
key x and a subarray T Œp : : r, and it returns one of the following:
   If T Œp : : r is empty (r < p), then it returns the index p.
   If x  T Œp, and hence less than or equal to all the elements of T Œp : : r, then
    it returns the index p.
   If x > T Œp, then it returns the largest index q in the range p < q  r C 1 such
    that T Œq  1 < x.
Here is the pseudocode:
B INARY-S EARCH .x; T; p; r/
1 low D p
2 high D max.p; r C 1/
3 while low < high
4      mid D b.low C high/=2c
5      if x  T Œmid
6           high D mid
7      else low D mid C 1
8 return high
