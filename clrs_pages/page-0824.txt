27.3 Multithreaded merge sort                                                          803


P-M ERGE -S ORT .A; p; r; B; s/
 1 n D r pC1
 2 if n == 1
 3      BŒs D AŒp
 4 else let T Œ1 : : n be a new array
 5      q D b.p C r/=2c
 6      q0 D q  p C 1
 7      spawn P-M ERGE -S ORT .A; p; q; T; 1/
 8      P-M ERGE -S ORT .A; q C 1; r; T; q 0 C 1/
 9      sync
10      P-M ERGE .T; 1; q 0 ; q 0 C 1; n; B; s/

After line 1 computes the number n of elements in the input subarray AŒp : : r,
lines 2–3 handle the base case when the array has only 1 element. Lines 4–6 set
up for the recursive spawn in line 7 and call in line 8, which operate in parallel. In
particular, line 4 allocates a temporary array T with n elements to store the results
of the recursive merge sorting. Line 5 calculates the index q of AŒp : : r to divide
the elements into the two subarrays AŒp : : q and AŒq C 1 : : r that will be sorted
recursively, and line 6 goes on to compute the number q 0 of elements in the ﬁrst
subarray AŒp : : q, which line 8 uses to determine the starting index in T of where
to store the sorted result of AŒq C 1 : : r. At that point, the spawn and recursive
call are made, followed by the sync in line 9, which forces the procedure to wait
until the spawned procedure is done. Finally, line 10 calls P-M ERGE to merge
the sorted subarrays, now in T Œ1 : : q 0  and T Œq 0 C 1 : : n, into the output subarray
BŒs : : s C r  p.

Analysis of multithreaded merge sort
We start by analyzing the work PMS1 .n/ of P-M ERGE -S ORT, which is consider-
ably easier than analyzing the work of P-M ERGE. Indeed, the work is given by the
recurrence
PMS1 .n/ D 2 PMS1 .n=2/ C PM 1 .n/
         D 2 PMS1 .n=2/ C ‚.n/ :
This recurrence is the same as the recurrence (4.4) for ordinary M ERGE -S ORT
from Section 2.3.1 and has solution PMS1 .n/ D ‚.n lg n/ by case 2 of the master
theorem.
   We now derive and analyze a recurrence for the worst-case span PMS1 .n/. Be-
cause the two recursive calls to P-M ERGE -S ORT on lines 7 and 8 operate logically
in parallel, we can ignore one of them, obtaining the recurrence
