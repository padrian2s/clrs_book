300   Chapter 12 Binary Search Trees


      tree varies, however, as items are inserted and deleted. If, for example, the n items
      are inserted in strictly increasing order, the tree will be a chain with height n  1.
      On the other hand, Exercise B.5-4 shows that h  blg nc. As with quicksort, we
      can show that the behavior of the average case is much closer to the best case than
      to the worst case.
         Unfortunately, little is known about the average height of a binary search tree
      when both insertion and deletion are used to create it. When the tree is created
      by insertion alone, the analysis becomes more tractable. Let us therefore deﬁne a
      randomly built binary search tree on n keys as one that arises from inserting the
      keys in random order into an initially empty tree, where each of the nŠ permutations
      of the input keys is equally likely. (Exercise 12.4-3 asks you to show that this notion
      is different from assuming that every binary search tree on n keys is equally likely.)
      In this section, we shall prove the following theorem.

      Theorem 12.4
      The expected height of a randomly built binary search tree on n distinct keys is
      O.lg n/.

      Proof We start by deﬁning three random variables that help measure the height
      of a randomly built binary search tree. We denote the height of a randomly built
      binary search on n keys by Xn , and we deﬁne the exponential height Yn D 2Xn .
      When we build a binary search tree on n keys, we choose one key as that of the
      root, and we let Rn denote the random variable that holds this key’s rank within
      the set of n keys; that is, Rn holds the position that this key would occupy if the
      set of keys were sorted. The value of Rn is equally likely to be any element of the
      set f1; 2; : : : ; ng. If Rn D i, then the left subtree of the root is a randomly built
      binary search tree on i  1 keys, and the right subtree is a randomly built binary
      search tree on n  i keys. Because the height of a binary tree is 1 more than the
      larger of the heights of the two subtrees of the root, the exponential height of a
      binary tree is twice the larger of the exponential heights of the two subtrees of the
      root. If we know that Rn D i, it follows that
      Yn D 2  max.Yi 1 ; Yni / :
      As base cases, we have that Y1 D 1, because the exponential height of a tree with 1
      node is 20 D 1 and, for convenience, we deﬁne Y0 D 0.
        Next, deﬁne indicator random variables Zn;1 ; Zn;2 ; : : : ; Zn;n , where
      Zn;i D I fRn D ig :
      Because Rn is equally likely to be any element of f1; 2; : : : ; ng, it follows that
      Pr fRn D ig D 1=n for i D 1; 2; : : : ; n, and hence, by Lemma 5.1, we have
      E ŒZn;i  D 1=n ;                                                               (12.1)
