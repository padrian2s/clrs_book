794   Chapter 27 Multithreaded Algorithms


      this divide-and-conquer strategy using nested parallelism. Unlike the S QUARE -
      M ATRIX -M ULTIPLY-R ECURSIVE procedure on which it is based, P-M ATRIX -
      M ULTIPLY-R ECURSIVE takes the output matrix as a parameter to avoid allocating
      matrices unnecessarily.

      P-M ATRIX -M ULTIPLY-R ECURSIVE .C; A; B/
       1 n D A:rows
       2 if n == 1
       3      c11 D a11 b11
       4 else let T be a new n n matrix
       5      partition A, B, C , and T into n=2 n=2 submatrices
                   A11 ; A12 ; A21 ; A22 ; B11 ; B12 ; B21 ; B22 ; C11 ; C12 ; C21 ; C22 ;
                   and T11 ; T12 ; T21 ; T22 ; respectively
       6      spawn P-M ATRIX -M ULTIPLY-R ECURSIVE .C11 ; A11 ; B11 /
       7      spawn P-M ATRIX -M ULTIPLY-R ECURSIVE .C12 ; A11 ; B12 /
       8      spawn P-M ATRIX -M ULTIPLY-R ECURSIVE .C21 ; A21 ; B11 /
       9      spawn P-M ATRIX -M ULTIPLY-R ECURSIVE .C22 ; A21 ; B12 /
      10      spawn P-M ATRIX -M ULTIPLY-R ECURSIVE .T11 ; A12 ; B21 /
      11      spawn P-M ATRIX -M ULTIPLY-R ECURSIVE .T12 ; A12 ; B22 /
      12      spawn P-M ATRIX -M ULTIPLY-R ECURSIVE .T21 ; A22 ; B21 /
      13      P-M ATRIX -M ULTIPLY-R ECURSIVE .T22 ; A22 ; B22 /
      14      sync
      15      parallel for i D 1 to n
      16           parallel for j D 1 to n
      17                cij D cij C tij

      Line 3 handles the base case, where we are multiplying 1 1 matrices. We handle
      the recursive case in lines 4–17. We allocate a temporary matrix T in line 4, and
      line 5 partitions each of the matrices A, B, C , and T into n=2 n=2 submatrices.
      (As with S QUARE -M ATRIX -M ULTIPLY-R ECURSIVE on page 77, we gloss over
      the minor issue of how to use index calculations to represent submatrix sections
      of a matrix.) The recursive call in line 6 sets the submatrix C11 to the submatrix
      product A11 B11 , so that C11 equals the ﬁrst of the two terms that form its sum in
      equation (27.6). Similarly, lines 7–9 set C12 , C21 , and C22 to the ﬁrst of the two
      terms that equal their sums in equation (27.6). Line 10 sets the submatrix T11 to
      the submatrix product A12 B21 , so that T11 equals the second of the two terms that
      form C11 ’s sum. Lines 11–13 set T12 , T21 , and T22 to the second of the two terms
      that form the sums of C12 , C21 , and C22 , respectively. The ﬁrst seven recursive
      calls are spawned, and the last one runs in the main strand. The sync statement in
      line 14 ensures that all the submatrix products in lines 6–13 have been computed,
